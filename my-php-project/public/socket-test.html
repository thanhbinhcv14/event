<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Test - Event Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .test-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-disconnected {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .notification-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        
        .notification-item.new-event {
            border-left-color: #28a745;
        }
        
        .notification-item.status-update {
            border-left-color: #ffc107;
        }
        
        .notification-item.admin-comment {
            border-left-color: #17a2b8;
        }
        
        .chat-message {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #667eea;
        }
        
        .chat-message.admin {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }
        
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border: none;
        }
        
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            border: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="row">
            <div class="col-md-4">
                <h2 class="mb-4">
                    <i class="fa fa-plug me-2"></i>Socket.IO Test
                </h2>
                
                <!-- Connection Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                            Trạng thái kết nối
                        </h5>
                    </div>
                    <div class="card-body">
                        <p id="connectionStatus">Chưa kết nối</p>
                        <p id="connectionInfo" class="text-muted small"></p>
                    </div>
                </div>
                
                <!-- User Authentication -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fa fa-user me-2"></i>Xác thực người dùng
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="userId" class="form-label">User ID:</label>
                            <input type="number" class="form-control" id="userId" value="1">
                        </div>
                        <div class="mb-3">
                            <label for="userRole" class="form-label">User Role:</label>
                            <select class="form-select" id="userRole">
                                <option value="5">Khách hàng (5)</option>
                                <option value="1">Quản trị viên (1)</option>
                                <option value="2">Quản lý tài chính (2)</option>
                                <option value="3">Quản lý sự kiện (3)</option>
                                <option value="4">Nhân viên (4)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="userName" class="form-label">Tên người dùng:</label>
                            <input type="text" class="form-control" id="userName" value="Test User">
                        </div>
                        <button class="btn btn-primary w-100" onclick="authenticate()">
                            <i class="fa fa-sign-in-alt me-2"></i>Kết nối
                        </button>
                    </div>
                </div>
                
                <!-- Test Events -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fa fa-cogs me-2"></i>Test Events
                        </h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success w-100 mb-2" onclick="testEventRegistration()">
                            <i class="fa fa-calendar-plus me-2"></i>Test Đăng ký sự kiện
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="testStatusUpdate()">
                            <i class="fa fa-check-circle me-2"></i>Test Cập nhật trạng thái
                        </button>
                        <button class="btn btn-info w-100 mb-2" onclick="testAdminComment()">
                            <i class="fa fa-comment me-2"></i>Test Ghi chú admin
                        </button>
                        <button class="btn btn-secondary w-100" onclick="testSystemNotification()">
                            <i class="fa fa-bell me-2"></i>Test Thông báo hệ thống
                        </button>
                    </div>
                </div>
                
                <!-- Chat -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fa fa-comments me-2"></i>Chat Real-time
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="chatMessage" placeholder="Nhập tin nhắn...">
                        </div>
                        <button class="btn btn-primary w-100" onclick="sendChatMessage()">
                            <i class="fa fa-paper-plane me-2"></i>Gửi tin nhắn
                        </button>
                        <div id="typingIndicator" class="typing-indicator mt-2" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <!-- Notifications -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fa fa-bell me-2"></i>Thông báo Real-time
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearNotifications()">
                            <i class="fa fa-trash me-1"></i>Xóa tất cả
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="notificationsList">
                            <p class="text-muted text-center">Chưa có thông báo nào</p>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fa fa-comments me-2"></i>Tin nhắn Chat
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                            <i class="fa fa-trash me-1"></i>Xóa chat
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="chatMessages">
                            <p class="text-muted text-center">Chưa có tin nhắn nào</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let isAuthenticated = false;
        let currentUser = {};

        // Initialize socket connection
        function initSocket() {
            socket = io();
            
            // Connection events
            socket.on('connect', () => {
                updateConnectionStatus(true);
                console.log('Connected to server');
            });
            
            socket.on('disconnect', () => {
                updateConnectionStatus(false);
                console.log('Disconnected from server');
            });
            
            // Authentication events
            socket.on('authenticated', (data) => {
                isAuthenticated = true;
                currentUser = data;
                addNotification('success', 'Đã xác thực thành công!', 'Xác thực');
                console.log('Authenticated:', data);
            });
            
            // Event registration notifications
            socket.on('new_event_registration', (data) => {
                addNotification('new-event', data.message, 'Sự kiện mới', data);
            });
            
            // Event status updates
            socket.on('event_status_change', (data) => {
                addNotification('status-update', data.message, 'Cập nhật trạng thái', data);
            });
            
            // Admin comments
            socket.on('admin_comment', (data) => {
                addNotification('admin-comment', data.message, 'Ghi chú admin', data);
            });
            
            // Admin notifications
            socket.on('admin_notification', (data) => {
                addNotification('info', data.message, 'Thông báo admin', data);
            });
            
            // System notifications
            socket.on('system_notification', (data) => {
                addNotification('info', data.message, 'Thông báo hệ thống', data);
            });
            
            // Chat messages
            socket.on('chat_message', (data) => {
                addChatMessage(data);
            });
            
            // Typing indicators
            socket.on('user_typing', (data) => {
                updateTypingIndicator(data);
            });
            
            // Ping/pong
            socket.on('pong', () => {
                console.log('Pong received');
            });
        }
        
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            const info = document.getElementById('connectionInfo');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                status.textContent = 'Đã kết nối';
                info.textContent = `Socket ID: ${socket.id}`;
            } else {
                indicator.className = 'status-indicator status-disconnected';
                status.textContent = 'Mất kết nối';
                info.textContent = '';
            }
        }
        
        function authenticate() {
            const userId = document.getElementById('userId').value;
            const userRole = document.getElementById('userRole').value;
            const userName = document.getElementById('userName').value;
            
            if (!socket || !socket.connected) {
                alert('Chưa kết nối đến server');
                return;
            }
            
            socket.emit('authenticate', {
                userId: parseInt(userId),
                userRole: parseInt(userRole),
                userName: userName
            });
        }
        
        function testEventRegistration() {
            if (!isAuthenticated) {
                alert('Vui lòng xác thực trước');
                return;
            }
            
            socket.emit('event_registered', {
                eventName: 'Sự kiện test ' + new Date().getTime(),
                userName: currentUser.userName || 'Test User',
                eventId: Math.floor(Math.random() * 1000)
            });
        }
        
        function testStatusUpdate() {
            if (!isAuthenticated) {
                alert('Vui lòng xác thực trước');
                return;
            }
            
            const statuses = ['approved', 'rejected'];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            
            socket.emit('event_status_updated', {
                eventId: Math.floor(Math.random() * 1000),
                eventName: 'Sự kiện test',
                status: status,
                userName: 'Test User',
                adminName: 'Admin Test',
                userId: currentUser.userId
            });
        }
        
        function testAdminComment() {
            if (!isAuthenticated) {
                alert('Vui lòng xác thực trước');
                return;
            }
            
            socket.emit('admin_comment_added', {
                eventId: Math.floor(Math.random() * 1000),
                eventName: 'Sự kiện test',
                comment: 'Đây là ghi chú test từ admin',
                adminName: 'Admin Test',
                userId: currentUser.userId
            });
        }
        
        function testSystemNotification() {
            if (!socket || !socket.connected) {
                alert('Chưa kết nối đến server');
                return;
            }
            
            // This would typically be sent from server side
            addNotification('info', 'Đây là thông báo hệ thống test', 'Hệ thống');
        }
        
        function sendChatMessage() {
            const messageInput = document.getElementById('chatMessage');
            const message = messageInput.value.trim();
            
            if (!message || !isAuthenticated) {
                return;
            }
            
            socket.emit('chat_message', {
                message: message,
                userName: currentUser.userName || 'Test User',
                userRole: currentUser.userRole
            });
            
            messageInput.value = '';
        }
        
        function addNotification(type, message, title, data = null) {
            const notificationsList = document.getElementById('notificationsList');
            
            // Remove "no notifications" message
            if (notificationsList.querySelector('.text-muted')) {
                notificationsList.innerHTML = '';
            }
            
            const notification = document.createElement('div');
            notification.className = `notification-item ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${title}</h6>
                        <p class="mb-1">${message}</p>
                        ${data ? `<small class="text-muted">ID: ${data.eventId || 'N/A'}</small>` : ''}
                    </div>
                    <small class="text-muted">${timestamp}</small>
                </div>
            `;
            
            notificationsList.insertBefore(notification, notificationsList.firstChild);
            
            // Auto-scroll to top
            notificationsList.scrollTop = 0;
        }
        
        function addChatMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove "no messages" message
            if (chatMessages.querySelector('.text-muted')) {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${data.userRole && [1,2,3,4].includes(parseInt(data.userRole)) ? 'admin' : ''}`;
            
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            
            messageDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${data.userName}</strong>
                        ${data.userRole && [1,2,3,4].includes(parseInt(data.userRole)) ? '<span class="badge bg-primary ms-2">Admin</span>' : ''}
                        <p class="mb-0 mt-1">${data.message}</p>
                    </div>
                    <small class="text-muted">${timestamp}</small>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Auto-scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function updateTypingIndicator(data) {
            const indicator = document.getElementById('typingIndicator');
            
            if (data.isTyping) {
                indicator.textContent = `${data.userName} đang nhập...`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }
        
        function clearNotifications() {
            document.getElementById('notificationsList').innerHTML = '<p class="text-muted text-center">Chưa có thông báo nào</p>';
        }
        
        function clearChat() {
            document.getElementById('chatMessages').innerHTML = '<p class="text-muted text-center">Chưa có tin nhắn nào</p>';
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            
            // Handle Enter key in chat
            document.getElementById('chatMessage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // Handle typing indicators
            let typingTimer;
            document.getElementById('chatMessage').addEventListener('input', function() {
                if (isAuthenticated) {
                    socket.emit('typing_start');
                    
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        socket.emit('typing_stop');
                    }, 1000);
                }
            });
        });
    </script>
</body>
</html>
